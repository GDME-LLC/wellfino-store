{% assign collage_width = image_width | default: 900 %}
{% assign stack_items = blank %}
{% if product_object != blank %}
  {% assign stack_items = product_object.metafields.custom.stack_items.value | default: product_object.metafields.custom.stack_items %}
{% endif %}
{% assign rendered_stack_items = 0 %}
{% assign collage_count = 0 %}

{% if stack_items != blank %}
  {% for stack_item in stack_items limit: 4 %}
    {% if stack_item.featured_image %}
      {% assign collage_count = collage_count | plus: 1 %}
    {% endif %}
  {% endfor %}
{% endif %}

{% if collage_count == 0 and product_object != blank and product_object.featured_image %}
  {% assign collage_count = 1 %}
{% endif %}

{% assign stack_handle = product_object.handle | default: '' | downcase %}
{% assign resolved_layout_key = layout_key | default: '' %}
{% if resolved_layout_key == blank %}
  {% assign resolved_layout_key = 'stack-' | append: collage_count %}
{% endif %}

{% assign layout_1 = '0|0|88|1|3|0|0|90|1' %}
{% assign layout_2_1 = '-12|2|56|0.95|2|-10|2|60|0.93' %}
{% assign layout_2_2 = '12|0|58|1.02|4|10|0|62|1' %}
{% assign layout_3_1 = '-18|2|50|0.92|2|-16|2|54|0.9' %}
{% assign layout_3_2 = '0|0|56|1.06|4|0|0|60|1.02' %}
{% assign layout_3_3 = '18|3|48|0.9|1|16|3|52|0.88' %}
{% assign layout_4_1 = '-22|2|46|0.92|2|-20|2|50|0.9' %}
{% assign layout_4_2 = '6|0|56|1.08|5|6|0|60|1.04' %}
{% assign layout_4_3 = '22|2|48|0.94|3|20|2|52|0.92' %}
{% assign layout_4_4 = '-4|4|44|0.88|1|-4|4|48|0.86' %}

{% comment %}
  Shared stack collage config used by grid cards + PDP.
  Format per item (desktop|mobile):
  x-d|y-d|w-d|s-d|z|x-m|y-m|w-m|s-m
{% endcomment %}
{% if stack_handle contains 'complete-system' %}
  {% assign layout_4_1 = '-24|2|46|0.92|2|-22|2|50|0.9' %}
  {% assign layout_4_2 = '8|0|58|1.1|5|8|0|62|1.06' %}
  {% assign layout_4_3 = '24|2|49|0.95|3|22|2|54|0.93' %}
  {% assign layout_4_4 = '-6|4|45|0.9|1|-6|4|49|0.88' %}
{% endif %}
{% if stack_handle contains 'focus-cognition' %}
  {% assign layout_3_1 = '-18|2|49|0.93|2|-16|2|53|0.91' %}
  {% assign layout_3_2 = '0|0|55|1|4|0|0|59|0.98' %}
  {% assign layout_3_3 = '18|1|54|1.04|3|16|1|58|1' %}
{% endif %}

<div class="wf-stack-collage wf-stack-collage--count-{{ collage_count }}{% if class_name != blank %} {{ class_name }}{% endif %}" data-layout-key="{{ resolved_layout_key }}">
  {% if stack_items != blank %}
    {% for stack_item in stack_items limit: 4 %}
      {% if stack_item.featured_image %}
        {% assign rendered_stack_items = rendered_stack_items | plus: 1 %}
        {% assign item_layout = layout_1 %}
        {% if collage_count == 2 %}
          {% if forloop.index == 1 %}{% assign item_layout = layout_2_1 %}{% else %}{% assign item_layout = layout_2_2 %}{% endif %}
        {% elsif collage_count == 3 %}
          {% if forloop.index == 1 %}{% assign item_layout = layout_3_1 %}{% elsif forloop.index == 2 %}{% assign item_layout = layout_3_2 %}{% else %}{% assign item_layout = layout_3_3 %}{% endif %}
        {% elsif collage_count == 4 %}
          {% if forloop.index == 1 %}{% assign item_layout = layout_4_1 %}{% elsif forloop.index == 2 %}{% assign item_layout = layout_4_2 %}{% elsif forloop.index == 3 %}{% assign item_layout = layout_4_3 %}{% else %}{% assign item_layout = layout_4_4 %}{% endif %}
        {% endif %}
        {% assign item_parts = item_layout | split: '|' %}

        {% assign stack_item_title_down = stack_item.title | downcase %}
        {% assign scale_bonus = 1.0 %}
        {% if stack_item_title_down contains 'creatine' or stack_item_title_down contains 'whey' or stack_item_title_down contains 'protein' or stack_item_title_down contains 'collagen' or stack_item_title_down contains 'electrolyte' or stack_item_title_down contains 'amino' %}
          {% assign scale_bonus = 1.08 %}
        {% elsif stack_item_title_down contains 'gummies' %}
          {% assign scale_bonus = 1.03 %}
        {% endif %}
        {% assign desktop_scale = item_parts[3] | times: 1.0 | times: scale_bonus %}
        {% assign mobile_scale = item_parts[8] | times: 1.0 | times: scale_bonus %}

        {% capture mapped_stack_item_image %}{% render 'wf-stack-image-url', item: stack_item %}{% endcapture %}
        {% assign mapped_stack_item_image = mapped_stack_item_image | strip %}
        <img
          class="wf-stack-collage__img wf-stack-collage__img--{{ forloop.index }}"
          src="{% if mapped_stack_item_image != blank %}{{ mapped_stack_item_image }}{% else %}{{ stack_item.featured_image | image_url: width: collage_width }}{% endif %}"
          alt="{{ stack_item.title | escape }}"
          data-wf-stack-image="1"
          style="--x-d:{{ item_parts[0] }};--y-d:{{ item_parts[1] }};--w-d:{{ item_parts[2] }}%;--s-d:{{ desktop_scale }};--z:{{ item_parts[4] }};--x-m:{{ item_parts[5] }};--y-m:{{ item_parts[6] }};--w-m:{{ item_parts[7] }}%;--s-m:{{ mobile_scale }};"
          loading="lazy">
      {% endif %}
    {% endfor %}
  {% endif %}

  {% if rendered_stack_items == 0 and product_object != blank and product_object.featured_image %}
    {% capture mapped_product_image %}{% render 'wf-stack-image-url', item: product_object %}{% endcapture %}
    {% assign mapped_product_image = mapped_product_image | strip %}
    <img
      class="wf-stack-collage__img wf-stack-collage__img--single"
      src="{% if mapped_product_image != blank %}{{ mapped_product_image }}{% else %}{{ product_object.featured_image | image_url: width: collage_width }}{% endif %}"
      alt="{{ product_object.featured_image.alt | default: product_object.title | escape }}"
      data-wf-stack-image="1"
      style="--x-d:0;--y-d:0;--w-d:88%;--s-d:1;--z:3;--x-m:0;--y-m:0;--w-m:90%;--s-m:1;"
      loading="lazy">
  {% endif %}

  {% if rendered_stack_items == 0 %}
    {% if product_object == blank or product_object.featured_image == blank %}
      <img
        class="wf-stack-collage__img wf-stack-collage__img--single"
        src="{{ 'stack-collage-placeholder.svg' | asset_url }}"
        alt="{{ product_object.title | default: 'Stack image placeholder' | escape }}"
        loading="lazy">
    {% endif %}
  {% endif %}
</div>
