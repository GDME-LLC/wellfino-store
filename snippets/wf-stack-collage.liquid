{% assign collage_width = image_width | default: 900 %}
{% assign stack_items = blank %}
{% if product_object != blank %}
  {% assign stack_items = product_object.metafields.custom.stack_items.value | default: product_object.metafields.custom.stack_items %}
{% endif %}
{% assign rendered_stack_items = 0 %}
{% assign collage_count = 0 %}

{% if stack_items != blank %}
  {% for stack_item in stack_items limit: 4 %}
    {% if stack_item.featured_image %}
      {% assign collage_count = collage_count | plus: 1 %}
    {% endif %}
  {% endfor %}
{% endif %}

{% if collage_count == 0 and product_object != blank and product_object.featured_image %}
  {% assign collage_count = 1 %}
{% endif %}

{% assign stack_handle = product_object.handle | default: '' | downcase %}
{% assign resolved_layout_key = layout_key | default: '' %}
{% if resolved_layout_key == blank %}
  {% assign resolved_layout_key = 'stack-' | append: collage_count %}
{% endif %}

{% assign layout_1 = '0|0|90|1.04|3|0|0|92|1.02' %}
{% assign layout_2_1 = '-18|0|56|1.08|2|-15|0|60|1.04' %}
{% assign layout_2_2 = '12|1|54|0.98|1|10|1|58|0.96' %}
{% assign layout_3_1 = '-26|0|54|1.12|3|-22|0|58|1.08' %}
{% assign layout_3_2 = '-10|1|48|0.98|2|-8|1|52|0.95' %}
{% assign layout_3_3 = '6|2|44|0.90|1|6|2|48|0.88' %}
{% assign layout_4_1 = '-30|0|50|1.08|3|-26|0|54|1.04' %}
{% assign layout_4_2 = '-14|1|46|0.96|2|-12|1|50|0.93' %}
{% assign layout_4_3 = '2|2|42|0.88|1|2|2|46|0.86' %}
{% assign layout_4_4 = '30|0|58|1.20|4|26|0|62|1.14' %}

{% comment %}
  Shared stack collage config used by grid cards + PDP.
  Format per item (desktop|mobile):
  x-d|y-d|w-d|s-d|z|x-m|y-m|w-m|s-m
{% endcomment %}
{% comment %}
  Optional override hook:
  if resolved_layout_key == 'womens-complete-system' etc, override layout_* vars here.
{% endcomment %}

<div class="wf-stack-collage wf-stack-collage--count-{{ collage_count }}{% if class_name != blank %} {{ class_name }}{% endif %}" data-layout-key="{{ resolved_layout_key }}">
  {% if stack_items != blank %}
    {% for stack_item in stack_items limit: 4 %}
      {% if stack_item.featured_image %}
        {% assign rendered_stack_items = rendered_stack_items | plus: 1 %}
        {% assign item_layout = layout_1 %}
        {% if collage_count == 2 %}
          {% if forloop.index == 1 %}{% assign item_layout = layout_2_1 %}{% else %}{% assign item_layout = layout_2_2 %}{% endif %}
        {% elsif collage_count == 3 %}
          {% if forloop.index == 1 %}{% assign item_layout = layout_3_1 %}{% elsif forloop.index == 2 %}{% assign item_layout = layout_3_2 %}{% else %}{% assign item_layout = layout_3_3 %}{% endif %}
        {% elsif collage_count == 4 %}
          {% if forloop.index == 1 %}{% assign item_layout = layout_4_1 %}{% elsif forloop.index == 2 %}{% assign item_layout = layout_4_2 %}{% elsif forloop.index == 3 %}{% assign item_layout = layout_4_3 %}{% else %}{% assign item_layout = layout_4_4 %}{% endif %}
        {% endif %}
        {% assign item_parts = item_layout | split: '|' %}

        {% assign desktop_scale = item_parts[3] | times: 1.0 %}
        {% assign mobile_scale = item_parts[8] | times: 1.0 %}

        {% capture mapped_stack_item_image %}{% render 'wf-stack-image-url', item: stack_item %}{% endcapture %}
        {% assign mapped_stack_item_image = mapped_stack_item_image | strip %}
        <img
          class="wf-stack-collage__img wf-stack-collage__img--{{ forloop.index }}"
          src="{% if mapped_stack_item_image != blank %}{{ mapped_stack_item_image }}{% else %}{{ stack_item.featured_image | image_url: width: collage_width }}{% endif %}"
          alt="{{ stack_item.title | escape }}"
          data-wf-stack-image="1"
          style="--x-d:{{ item_parts[0] }};--y-d:{{ item_parts[1] }};--w-d:{{ item_parts[2] }}%;--s-d:{{ desktop_scale }};--z:{{ item_parts[4] }};--x-m:{{ item_parts[5] }};--y-m:{{ item_parts[6] }};--w-m:{{ item_parts[7] }}%;--s-m:{{ mobile_scale }};"
          loading="lazy">
      {% endif %}
    {% endfor %}
  {% endif %}

  {% if rendered_stack_items == 0 and product_object != blank and product_object.featured_image %}
    {% capture mapped_product_image %}{% render 'wf-stack-image-url', item: product_object %}{% endcapture %}
    {% assign mapped_product_image = mapped_product_image | strip %}
    <img
      class="wf-stack-collage__img wf-stack-collage__img--single"
      src="{% if mapped_product_image != blank %}{{ mapped_product_image }}{% else %}{{ product_object.featured_image | image_url: width: collage_width }}{% endif %}"
      alt="{{ product_object.featured_image.alt | default: product_object.title | escape }}"
      data-wf-stack-image="1"
      style="--x-d:0;--y-d:0;--w-d:88%;--s-d:1;--z:3;--x-m:0;--y-m:0;--w-m:90%;--s-m:1;"
      loading="lazy">
  {% endif %}

  {% if rendered_stack_items == 0 %}
    {% if product_object == blank or product_object.featured_image == blank %}
      <img
        class="wf-stack-collage__img wf-stack-collage__img--single"
        src="{{ 'stack-collage-placeholder.svg' | asset_url }}"
        alt="{{ product_object.title | default: 'Stack image placeholder' | escape }}"
        loading="lazy">
    {% endif %}
  {% endif %}
</div>
