{% assign collage_width = image_width | default: 900 %}
{% assign stack_items = blank %}
{% if product_object != blank %}
  {% assign stack_items = product_object.metafields.custom.stack_items.value | default: product_object.metafields.custom.stack_items %}
{% endif %}
{% assign rendered_stack_items = 0 %}
{% assign collage_count = 0 %}

{% if stack_items != blank %}
  {% for stack_item in stack_items limit: 4 %}
    {% if stack_item.featured_image %}
      {% assign collage_count = collage_count | plus: 1 %}
    {% endif %}
  {% endfor %}
{% endif %}

{% if collage_count == 0 and product_object != blank and product_object.featured_image %}
  {% assign collage_count = 1 %}
{% endif %}

<div class="wf-stack-collage wf-stack-collage--count-{{ collage_count }}{% if class_name != blank %} {{ class_name }}{% endif %}">
  {% if stack_items != blank %}
    {% for stack_item in stack_items limit: 4 %}
      {% if stack_item.featured_image %}
        {% assign rendered_stack_items = rendered_stack_items | plus: 1 %}
        {% capture mapped_stack_item_image %}{% render 'wf-stack-image-url', item: stack_item %}{% endcapture %}
        {% assign mapped_stack_item_image = mapped_stack_item_image | strip %}
        <img
          class="wf-stack-collage__img wf-stack-collage__img--{{ forloop.index }}"
          src="{% if mapped_stack_item_image != blank %}{{ mapped_stack_item_image }}{% else %}{{ stack_item.featured_image | image_url: width: collage_width }}{% endif %}"
          alt="{{ stack_item.title | escape }}"
          data-wf-stack-image="1"
          loading="lazy">
      {% endif %}
    {% endfor %}
  {% endif %}

  {% if rendered_stack_items == 0 and product_object != blank and product_object.featured_image %}
    {% capture mapped_product_image %}{% render 'wf-stack-image-url', item: product_object %}{% endcapture %}
    {% assign mapped_product_image = mapped_product_image | strip %}
    <img
      class="wf-stack-collage__img wf-stack-collage__img--single"
      src="{% if mapped_product_image != blank %}{{ mapped_product_image }}{% else %}{{ product_object.featured_image | image_url: width: collage_width }}{% endif %}"
      alt="{{ product_object.featured_image.alt | default: product_object.title | escape }}"
      data-wf-stack-image="1"
      loading="lazy">
  {% endif %}

  {% if rendered_stack_items == 0 %}
    {% if product_object == blank or product_object.featured_image == blank %}
      <img
        class="wf-stack-collage__img wf-stack-collage__img--single"
        src="{{ 'stack-collage-placeholder.svg' | asset_url }}"
        alt="{{ product_object.title | default: 'Stack image placeholder' | escape }}"
        loading="lazy">
    {% endif %}
  {% endif %}
</div>
