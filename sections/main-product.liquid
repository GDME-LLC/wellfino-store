<section class="wf-section">
  <div class="wf-wrap">
    {% assign product_type_down = product.type | downcase %}
    {% assign product_title_down = product.title | downcase %}
    {% assign product_tags_down = product.tags | join: ',' | downcase %}
    {% assign is_stack_anchor = false %}
    {% if product_type_down == 'stack' or product_tags_down contains 'stack' or product_title_down contains 'stack' or product_title_down contains 'system' %}
      {% assign is_stack_anchor = true %}
    {% endif %}

    {% assign stack_display_price = product.metafields.custom.stack_display_price.value | default: product.metafields.custom.stack_display_price %}
    {% assign stack_requires_options = false %}
    {% if is_stack_anchor %}
      {% if product.price <= 0 or product.available == false %}
        {% assign stack_requires_options = true %}
      {% endif %}
    {% endif %}

    <div class="wf-grid wf-product-hero">
      <div class="wf-tile">
        {% if is_stack_anchor %}
          <div class="wf-product-hero__media">
            {% render 'wf-stack-collage', product_object: product, class_name: 'wf-stack-collage--pdp', image_width: 1400 %}
          </div>
        {% elsif product.images.size > 0 %}
          <div class="wf-product-gallery" data-wf-product-gallery>
            {%- assign stage_image = product.images.first -%}
            <button type="button" class="wf-product-gallery__stage-btn" data-gallery-open aria-label="Open product image zoom view">
              <img
                src="{{ stage_image | image_url: width: 1800 }}"
                alt="{{ stage_image.alt | default: product.title | escape }}"
                class="wf-product-gallery__stage-image"
                data-gallery-stage
                data-gallery-index="0"
                loading="lazy">
            </button>

            {% if product.images.size > 1 %}
              <div class="wf-product-gallery__thumbs" role="list" aria-label="Product image thumbnails">
                {% for image in product.images %}
                  <button
                    type="button"
                    class="wf-product-gallery__thumb{% if forloop.first %} is-active{% endif %}"
                    data-gallery-thumb
                    data-gallery-index="{{ forloop.index0 }}"
                    data-gallery-src="{{ image | image_url: width: 1800 }}"
                    data-gallery-alt="{{ image.alt | default: product.title | escape }}"
                    aria-label="Show image {{ forloop.index }} of {{ product.images.size }}">
                    <img
                      src="{{ image | image_url: width: 240 }}"
                      alt="{{ image.alt | default: product.title | escape }}"
                      class="wf-product-gallery__thumb-image"
                      loading="lazy">
                  </button>
                {% endfor %}
              </div>
            {% endif %}

            <div class="wf-product-gallery__modal" data-gallery-modal hidden>
              <button type="button" class="wf-product-gallery__close" data-gallery-close aria-label="Close image zoom">Close</button>
              <div class="wf-product-gallery__modal-frame">
                <img src="{{ stage_image | image_url: width: 2400 }}" alt="{{ stage_image.alt | default: product.title | escape }}" class="wf-product-gallery__modal-image" data-gallery-modal-image>
              </div>
            </div>
          </div>
        {% endif %}

        {% if product.description != blank %}
          <div class="wf-product-hero__description">{{ product.description }}</div>
        {% endif %}
      </div>

      <div class="wf-tile wf-product-hero__aside">
        <h1 class="wf-product-hero__title">{{ product.title }}</h1>
        {% if is_stack_anchor %}
          <span class="wf-stack-badge">10% Stack Savings</span>
        {% endif %}

        <p class="wf-product-hero__price">
          {% if is_stack_anchor %}
            {% if stack_display_price != blank %}
              From {{ stack_display_price | money }}
            {% else %}
              10% savings &middot; Discount applied at checkout
            {% endif %}
          {% else %}
            {{ product.price | money }}
          {% endif %}
        </p>

        {% assign short_description = product.description | strip_html | strip_newlines | truncate: 140 %}
        {% if short_description != blank %}
          <p class="wf-product-hero__short">{{ short_description }}</p>
        {% endif %}

        {% if is_stack_anchor %}
          <p class="wf-product-hero__availability-note">Stack availability depends on included items.</p>
        {% endif %}

        {% unless stack_requires_options %}
          {% form 'product', product %}
            <input type="hidden" name="id" value="{{ product.selected_or_first_available_variant.id }}">
            <button class="wf-btn wf-btn--primary wf-product-hero__cart-btn" type="submit">Add to cart</button>
          {% endform %}
        {% else %}
          <div class="wf-product-hero__option-note">Choose stack options below to build your discounted stack.</div>
        {% endunless %}

        <a class="wf-btn wf-product-hero__cart-link" href="{{ routes.cart_url }}">Go to cart</a>

        <ul class="wf-trust-strip" aria-label="Wellfino trust standards">
          <li>&#10003; Packaged in the USA</li>
          <li>&#10003; Manufactured in FDA-Registered Facilities</li>
          <li>&#10003; GMP-Certified Production</li>
          <li>&#10003; Third-Party Tested for Quality</li>
        </ul>
      </div>
    </div>
  </div>
</section>

{% if is_stack_anchor %}
<section id="stack-options" class="wf-section wf-stack-options">
  <div class="wf-wrap">
    <div class="wf-section__head">
      <h2 class="wf-section__title">Stack Options</h2>
    </div>
    <div class="wf-stack-options__card">
      {% for block in section.blocks %}
        {% render block %}
      {% endfor %}
    </div>
  </div>
</section>
{% endif %}

{% assign stack_widget_fallback_image = 'stack-collage-placeholder.svg' | asset_url %}
{% if product.featured_image %}
  {% assign stack_widget_fallback_image = product.featured_image | image_url: width: 800 %}
{% endif %}
{% assign stack_items_for_widget = product.metafields.custom.stack_items.value | default: product.metafields.custom.stack_items %}
{% capture stack_widget_images_json -%}
[
{%- if stack_items_for_widget != blank -%}
  {%- assign first_widget_item = true -%}
  {%- for stack_item in stack_items_for_widget limit: 8 -%}
    {%- unless first_widget_item -%},{%- endunless -%}
    {%- assign first_widget_item = false -%}
    {%- capture mapped_stack_item_image -%}{% render 'wf-stack-image-url', item: stack_item %}{%- endcapture -%}
    {%- assign mapped_stack_item_image = mapped_stack_item_image | strip -%}
    {
      "title": {{ stack_item.title | json }},
      "title_down": {{ stack_item.title | downcase | json }},
      "handle": {{ stack_item.handle | default: '' | downcase | json }},
      "url": {% if stack_item.url %}{{ stack_item.url | json }}{% else %}""{% endif %},
      "image": {% if mapped_stack_item_image != blank %}{{ mapped_stack_item_image | json }}{% elsif stack_item.featured_image %}{{ stack_item.featured_image | image_url: width: 720 | json }}{% else %}{{ stack_widget_fallback_image | json }}{% endif %}
    }
  {%- endfor -%}
{%- endif -%}
]
{%- endcapture %}
<script>
  (function() {
    var hiddenClass = "wf-stack-options__hidden-item";
    var stackItemImages = {{ stack_widget_images_json | strip_newlines }};

    function onJump() {
      var jumpLink = document.querySelector("[data-stack-scroll]");
      if (!jumpLink) return;
      jumpLink.addEventListener("click", function(event) {
        var target = document.getElementById("stack-options");
        if (!target) return;
        event.preventDefault();
        target.scrollIntoView({ behavior: "smooth", block: "start" });
      });
    }

    function isBundlerHeading(text) {
      var t = (text || "").trim().toLowerCase();
      return t === "get a discount!" || t === "get a discount" || t === "discount";
    }

    function normalizeText(value) {
      return (value || "").toLowerCase().replace(/[^a-z0-9]+/g, " ").trim();
    }

    function normalizeHandle(value) {
      return (value || "").toLowerCase().replace(/-/g, " ").trim();
    }

    function tokens(value) {
      var text = normalizeText(value);
      if (!text) return [];
      return text.split(" ").filter(function(token) {
        return token.length > 2 && token !== "for" && token !== "and" && token !== "the" && token !== "with";
      });
    }

    function findStackImageByContextText(text) {
      var item = findStackItemByContextText(text);
      return item ? (item.image || "") : "";
    }

    function findStackItemByContextText(text) {
      if (!stackItemImages || !stackItemImages.length) return "";
      var normalized = normalizeText(text);
      if (!normalized) return null;

      var bestItem = null;
      var bestScore = 0;
      for (var i = 0; i < stackItemImages.length; i++) {
        var item = stackItemImages[i] || {};
        var itemTitle = normalizeText(item.title_down || item.title || "");
        var itemHandle = normalizeHandle(item.handle || "");
        var byTitle = itemTitle && (normalized.indexOf(itemTitle) !== -1 || itemTitle.indexOf(normalized) !== -1);
        var byHandle = itemHandle && normalized.indexOf(itemHandle) !== -1;
        if (byTitle || byHandle) {
          return item;
        }

        var itemTokens = tokens(itemTitle + " " + itemHandle);
        var score = 0;
        for (var j = 0; j < itemTokens.length; j++) {
          if (normalized.indexOf(itemTokens[j]) !== -1) score += 1;
        }
        if (score > bestScore) {
          bestScore = score;
          bestItem = item;
        }
      }
      return bestScore >= 2 ? bestItem : null;
    }

    function ensureBundleLinks(target) {
      if (!target || !stackItemImages || !stackItemImages.length) return;
      var contexts = target.querySelectorAll("li, article, tr, [class*='product'], [class*='item'], [class*='bundle']");
      contexts.forEach(function(node) {
        if (!node || node.classList.contains(hiddenClass)) return;
        var matched = findStackItemByContextText(node.textContent || "");
        if (!matched || !matched.url) return;

        var link = node.querySelector(".wf-stack-options__item-link");
        if (!link) {
          link = document.createElement("a");
          link.className = "wf-stack-options__item-link";
          link.textContent = "View product";
          node.appendChild(link);
        }
        link.setAttribute("href", matched.url);
      });
    }

    function patchStackOptions() {
      var target = document.getElementById("stack-options");
      if (!target) return;
      var fallbackSrc = {{ stack_widget_fallback_image | json }};

      target.querySelectorAll("h1, h2, h3, h4").forEach(function(el) {
        if (isBundlerHeading(el.textContent)) {
          el.classList.add(hiddenClass);
        }
      });

      target.querySelectorAll("img").forEach(function(img) {
        var src = (img.getAttribute("src") || "").trim().toLowerCase();
        var brokenBySrc = !src || src.indexOf("placeholder") !== -1 || src.indexOf("no-image") !== -1 || src.indexOf("missing") !== -1;
        var brokenBySize = img.complete && img.naturalWidth === 0;
        var contextNode = img.closest("li, article, tr, td, [class*='product'], [class*='item'], [class*='bundle'], div");
        var contextText = contextNode ? contextNode.textContent : "";
        var mappedSrc = findStackImageByContextText(contextText);
        if (mappedSrc) {
          var currentSrc = (img.getAttribute("src") || "").trim();
          if (!currentSrc || currentSrc.indexOf(mappedSrc) === -1) {
            img.setAttribute("src", mappedSrc);
            img.removeAttribute("srcset");
          }
          img.style.objectFit = "contain";
          img.style.background = "transparent";
          img.style.display = "block";
          img.style.visibility = "visible";
        } else if (brokenBySrc || brokenBySize) {
          img.setAttribute("src", fallbackSrc);
          img.removeAttribute("srcset");
          img.style.objectFit = "contain";
          img.style.background = "transparent";
          img.style.display = "block";
          img.style.visibility = "visible";
        }
      });

      ensureBundleLinks(target);

      // Keep Bundler output visible; previous broad selectors could hide the entire widget.
    }

    function initProductGallery() {
      var galleries = document.querySelectorAll("[data-wf-product-gallery]");
      galleries.forEach(function(gallery) {
        if (gallery.dataset.enhanced === "true") return;
        gallery.dataset.enhanced = "true";

        var stageImage = gallery.querySelector("[data-gallery-stage]");
        var thumbs = gallery.querySelectorAll("[data-gallery-thumb]");
        var openButton = gallery.querySelector("[data-gallery-open]");
        var modal = gallery.querySelector("[data-gallery-modal]");
        var modalImage = gallery.querySelector("[data-gallery-modal-image]");
        var closeButtons = gallery.querySelectorAll("[data-gallery-close]");

        function setActiveImage(src, alt, index) {
          if (!stageImage || !src) return;
          stageImage.setAttribute("src", src);
          stageImage.setAttribute("alt", alt || "");
          stageImage.setAttribute("data-gallery-index", String(index || 0));
          if (modalImage) {
            modalImage.setAttribute("src", src);
            modalImage.setAttribute("alt", alt || "");
          }
          thumbs.forEach(function(thumb) {
            thumb.classList.toggle("is-active", thumb.getAttribute("data-gallery-index") === String(index || 0));
          });
        }

        thumbs.forEach(function(thumb) {
          thumb.addEventListener("click", function() {
            setActiveImage(
              thumb.getAttribute("data-gallery-src"),
              thumb.getAttribute("data-gallery-alt"),
              thumb.getAttribute("data-gallery-index")
            );
          });
        });

        function closeModal() {
          if (!modal) return;
          modal.setAttribute("hidden", "");
          document.body.classList.remove("wf-modal-open");
        }

        function openModal() {
          if (!modal || !stageImage) return;
          if (modalImage) {
            modalImage.setAttribute("src", stageImage.getAttribute("src") || "");
            modalImage.setAttribute("alt", stageImage.getAttribute("alt") || "");
          }
          modal.removeAttribute("hidden");
          document.body.classList.add("wf-modal-open");
        }

        if (openButton) {
          openButton.addEventListener("click", openModal);
        }

        closeButtons.forEach(function(button) {
          button.addEventListener("click", closeModal);
        });

        if (modal) {
          modal.addEventListener("click", function(event) {
            if (event.target === modal) closeModal();
          });
        }

        document.addEventListener("keydown", function(event) {
          if (event.key === "Escape" && modal && !modal.hasAttribute("hidden")) {
            closeModal();
          }
        });
      });
    }

    onJump();
    initProductGallery();

    window.addEventListener("load", function() {
      initProductGallery();
      patchStackOptions();
      setTimeout(patchStackOptions, 350);
      setTimeout(patchStackOptions, 1200);
      var target = document.getElementById("stack-options");
      if (!target) return;
      var observer = new MutationObserver(function() { patchStackOptions(); });
      observer.observe(target, { childList: true, subtree: true });
      setTimeout(function() { observer.disconnect(); }, 15000);
    });
  })();
</script>

{{ 'wf-stack-collage.js' | asset_url | script_tag }}
{% schema %}
{
  "name": "Main product",
  "settings": [],
  "blocks": [
    { "type": "@app" }
  ]
}
{% endschema %}
