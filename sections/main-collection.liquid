<section class="wf-section">
  <div class="wf-wrap">
    <div class="wf-section__head">
      <h1 class="wf-section__title">{{ collection.title }}</h1>
    </div>

    <div class="wf-grid wf-product-grid">
      {% for product in collection.products %}
        {% assign product_type_down = product.type | downcase %}
        {% assign product_title_down = product.title | downcase %}
        {% assign product_tags_down = product.tags | join: ',' | downcase %}
        {% assign is_stack_anchor = false %}
        {% if product_type_down == 'stack' or product_tags_down contains 'stack' or product_title_down contains 'stack' or product_title_down contains 'system' %}
          {% assign is_stack_anchor = true %}
        {% endif %}
        {% assign stack_price_override = false %}
        {% assign stack_base_price = product.metafields.custom.stack_base_price.value | default: product.metafields.custom.stack_base_price %}
        {% if is_stack_anchor %}
          {% if product.price <= 0 or product.available == false %}
            {% assign stack_price_override = true %}
          {% endif %}
        {% endif %}

        <a class="wf-product-card" href="{{ product.url }}">
          <div class="wf-product-card__media">
            {% if product.featured_image %}
              <img
                class="wf-product-card__img"
                src="{{ product.featured_image | image_url: width: 720 }}"
                alt="{{ product.featured_image.alt | default: product.title | escape }}"
                loading="lazy">
            {% elsif is_stack_anchor %}
              {% render 'wf-stack-collage', product_object: product, image_width: 900 %}
            {% else %}
              <div class="wf-product-card__img wf-product-card__img--placeholder" aria-hidden="true">No Image</div>
            {% endif %}
            {% if is_stack_anchor %}
              <span class="wf-stack-badge wf-stack-badge--card">10% Stack Savings</span>
            {% endif %}
            <span class="wf-product-card__price">
              {% if stack_price_override %}
                {% if stack_base_price != blank %}
                  {% assign stack_base_price_text = stack_base_price | append: '' %}
                  {% if stack_base_price_text contains '$' %}
                    From {{ stack_base_price_text }}
                  {% else %}
                    From ${{ stack_base_price_text }}
                  {% endif %}
                {% else %}
                  Curated stack (10% savings)
                {% endif %}
              {% else %}
                {{ product.price | money }}
              {% endif %}
            </span>
          </div>
          <div class="wf-product-card__content">
            <h3>{{ product.title }}</h3>
            {% assign meta_list = '' %}
            {% assign meta_count = 0 %}
            {% for rel_collection in product.collections %}
              {% if rel_collection.handle != collection.handle %}
                {% assign meta_count = meta_count | plus: 1 %}
                {% if meta_count <= 2 %}
                  {% if meta_list != blank %}
                    {% assign meta_list = meta_list | append: ', ' %}
                  {% endif %}
                  {% assign meta_list = meta_list | append: rel_collection.title %}
                {% endif %}
              {% endif %}
            {% endfor %}
            {% if meta_count == 0 and product.tags.size > 0 %}
              {% assign meta_list = '' %}
              {% assign meta_count = 0 %}
              {% for tag in product.tags %}
                {% assign meta_count = meta_count | plus: 1 %}
                {% if meta_count <= 2 %}
                  {% if meta_list != blank %}
                    {% assign meta_list = meta_list | append: ', ' %}
                  {% endif %}
                  {% assign meta_list = meta_list | append: tag %}
                {% endif %}
              {% endfor %}
            {% endif %}
            <span class="wf-product-card__meta">
              {% if meta_list != blank %}
                {{ meta_list }}{% if meta_count > 2 %} + {{ meta_count | minus: 2 }} more{% endif %}
              {% else %}
                Foundational wellness support
              {% endif %}
            </span>
            {% assign rating_value = product.metafields.reviews.rating.value.rating | default: product.metafields.reviews.rating.value | default: 0 %}
            {% assign rating_count = product.metafields.reviews.rating_count.value | default: product.metafields.reviews.rating_count | default: 0 %}
            {% assign rating_scaled = rating_value | times: 1.0 %}
            {% if rating_count > 0 %}
              {% assign rating_stars = rating_scaled | round %}
              {% if rating_stars < 0 %}{% assign rating_stars = 0 %}{% endif %}
              {% if rating_stars > 5 %}{% assign rating_stars = 5 %}{% endif %}
              <span class="wf-product-card__rating">
                <span class="wf-product-card__stars" aria-hidden="true">
                  {% for star in (1..5) %}
                    {% if star <= rating_stars %}&#9733;{% else %}&#9734;{% endif %}
                  {% endfor %}
                </span>
                ({{ rating_scaled | round: 1 }}/5 &middot; {{ rating_count }} reviews)
              </span>
            {% endif %}
            <span class="wf-product-card__view">View &rarr;</span>
          </div>
        </a>
      {% endfor %}
    </div>
  </div>
</section>
{% schema %}{ "name": "Main collection", "settings": [] }{% endschema %}
